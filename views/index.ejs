<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Log In</title>
</head>
<body>
  <% if (locals.user) { %>
    <h1>Welcome Back <%= user.username %> id: <%= user.id %>!</h1>
    <% for (var i = 0; i < transactions.length ; i++) { %>
      <% if (transactions[i].name === "closing-date-official") { %>
        <% console.log('skipping transaction name = $1', [transactions[i].name]) %>
        <% continue; %>
      <% } else if (transactions[i].name === "pay-off-official") { %>
        <% usedCredit -= transactions[i].money %>
        <% continue; %>
      <% } %>
      <% totalSum += transactions[i].money %>
      <% usedCredit += transactions[i].money %>
    <% } %>
    <h2>You have $<%= (user.money / 100).toFixed(2) %> in savings</h2>
    <h2>Your credit balance is $<%= (usedCredit / 100).toFixed(2) %> / $<%= (user.credit / 100).toFixed(2) %></h2>
    <a href="/account">See Account</a>
    <ul>
      <% for (var i = 0; i < transactions.length ; i++) { %>

        <% if (transactions[i].name === "closing-date-official"){ %>
          <h3> Closing date: <%= moment(transactions[i].date).format('MMMM Do, YYYY'); %>, Money owed: <%= (closingSum / 100).toFixed(2) %>, 
            transaction id: <%= transactions[i].id %>,  user id: <%= transactions[i].user_id %>,  Your total spending is $<%= (totalSum / 100).toFixed(2) %></h3>
          <% closingSum = 0 %>
          <% totalSum = 0 %>
          <form action="/transaction/<%= transactions[i].id %>/delete?_method=DELETE" method="POST">
            <button type="submit" onclick="return confirm('Are you sure you want to delete this closing date?');">Delete</button>
          </form>

        <% } else if (transactions[i].name === "pay-off-official") { %>
          <li> Pay off amount: <%= (transactions[i].money / 100).toFixed(2) %>, transaction id: <%= transactions[i].id %>,  user id: <%= transactions[i].user_id %>,  
              name: <%= transactions[i].name %>, date: <%= moment(transactions[i].date).format('MMMM Do, YYYY'); %> </li> 
          <% closingSum -= transactions[i].money %>
          <form action="/transaction/<%= transactions[i].id %>/delete?_method=DELETE" method="POST">
            <button type="submit" onclick="return confirm('Are you sure you want to revert this payment?');">Delete</button>
          </form>

        <% } else { %>
          <li> transaction id: <%= transactions[i].id %>,  user id: <%= transactions[i].user_id %>,  name: <%= transactions[i].name %>,  
            money: <%= (transactions[i].money / 100).toFixed(2) %>,  date: <%= moment(transactions[i].date).format('MMMM Do, YYYY'); %> </li> 
          <% closingSum += transactions[i].money %>
          <a href="/transaction/<%= transactions[i].id %>/update">Edit</a>
          <form action="/transaction/<%= transactions[i].id %>/delete?_method=DELETE" method="POST">
            <button type="submit" onclick="return confirm('Are you sure you want to delete this transaction?');">Delete</button>
          </form>
        <% } %>
      <% } %>
    </ul>
    
    <% tempCredit = user.credit %>
    <% if(!tempCredit) { %>
      <% tempCredit = 1 %>
    <% } %>
    <h2>Your credit utilization is <%= ((usedCredit/tempCredit) * 100).toFixed(2) %>%</h2>
    <a href="/transaction">Add Transaction</a><br>
    <form action="/transaction/closing-date" method="POST">
      <label for="date">Date</label>
      <input id="date" name="date" type="date" required/>
      <button type="submit">Add Closing Date</button>
    </form>
    <form action="/transaction/pay-off" method="POST">
      <label for="money">Amount</label>
      <input id="money" name="money" type="number" step = "0.01" required min = "0.01"/>
      <button type="submit">Pay Off Credit</button>
    </form>

  <% } else { %>
    <h1>Please Log In</h1>
    <form action="/log-in" method="POST">
      <label for="username">Username</label>
      <input id="username" name="username" placeholder="username" type="text" required/>
      <label for="password">Password</label>
      <input id="password" name="password" type="password" required/>
      <button type="submit">Log In</button>
    </form>
    <a href="/sign-up">SIGN UP</a>
  <%}%>
</body>
</html>
